clc;
close all;
clear all
 load 'PFFSnet_DeepFish_TrainedModel'

dir_path = '';
file_name = sprintf('Acc_Dataset1_XIN_SLS.txt');
out = fullfile(dir_path,file_name);
fileID = fopen(out,'w');

fprintf(fileID,'\r\n');
 
Dri='';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
for ff=1:96
  
     Names = sprintf('%d%s',ff,'.png');
    
      Folder = fullfile(Dri,Names);
         GT=imread(Folder);  
         [x1,y1,z1]=size(GT);
         if z1==3
         GT=rgb2gray(GT);
         end
 
    num=num2str(ff); 
    file=strcat(num,'.jpg'); 
    image = (imread(file));
    im=image;
    im3=imresize(im,size(GT),'bilinear');
        [x1,x2,x3]=size(image); 
        Scolor1=image;
         Scolor2=image;
   if x3==3
   image=rgb2gray(image);
   NEW_img=image;
   end
      Orig_image=image;    
      imu=image>200;
       imd=image<150;

    tic;
       C = semanticseg(im,net);
      
toc;

 k2=C=='FISH';
 k3=C=='BG';

mask2=double(k2); 
mask3=double(k3); 

[labels_R1,scores_R1,allscores_R1] = semanticseg(im,net,'ExecutionEnvironment','gpu');

         mask2 = imresize(mask2,size(GT),'bilinear');

se = strel('disk',26);
  IM2 = imdilate(mask2,se);
  mask2=IM2; 

 se1 = strel('disk',22); 
  IM3=imerode(mask2,se1);
  mask2=IM3;

   se1 = strel('disk',2); 

 IM3=imdilate(mask2,se1);

         GT_OD=(GT~=0);


         imR=im3(:,:,1);
         imG=im3(:,:,2);
         imB=im3(:,:,3);
         [x1,y1]=size(GT_OD);
         
          tp_OD=0;
          tn_OD=0;
          fp_OD=0;
          fn_OD=0;
          
          
          tp_OC=0;
          tn_OC=0;
          fp_OC=0;
          fn_OC=0;
          
   for jj=1:x1
       
    
       
        for kk=1:y1
        
            if  GT_OD(jj,kk)==1 && mask2(jj,kk)==1
                 imR(jj,kk)=0;
                 imG(jj,kk)=0;
                 imB(jj,kk)=255;
                    tp_OD=tp_OD+1;
           elseif GT_OD(jj,kk)==0 && mask2(jj,kk)==0
              
                   tn_OD=tn_OD+1;
            elseif GT_OD(jj,kk)==0 && mask2(jj,kk)==1  
              
                  imR(jj,kk)=0;
                  imG(jj,kk)=255;
                  imB(jj,kk)=0;
                  fp_OD=fp_OD+1;

             elseif GT_OD(jj,kk)==1 && mask2(jj,kk)==0
                 imR(jj,kk)=255;
                 imG(jj,kk)=0;
                 imB(jj,kk)=0;
                 
                 fn_OD=fn_OD+1;
             end
            

             

            
        end
   end
   


PREC_OD=(tp_OD/(tp_OD+fp_OD)*100);
FPR_OD=(fp_OD/(fp_OD+tn_OD)*100);
ME_OD=((fp_OD+fn_OD)/(tp_OD+fp_OD+tn_OD+fn_OD)*100);

DI_OD=((2*tp_OD)/((2*tp_OD)+fn_OD+fp_OD)*100);
JA_OD=(tp_OD/(tp_OD+fn_OD+fp_OD)*100);
FNR_OD=(fn_OD/(fn_OD+tp_OD)*100);
RC_OD=(tp_OD/(tp_OD+fn_OD)*100);




%%Below is for ROC paper_i
% % SE_OD=(tp_OD/(tp_OD+fn_OD)*100);
% % FPR_OD=(fp_OD/(fp_OD+tn_OD)*100);
% % ME_OD=((fp_OD+fn_OD)/(tp_OD+fp_OD+tn_OD+fn_OD)*100);
% % 
% % DI_OD=((2*tp_OD)/((2*tp_OD)+fn_OD+fp_OD)*100);
% % JA_OD=(tp_OD/(tp_OD+fn_OD+fp_OD)*100);
% % SP_OD=(tn_OD/(tn_OD+fp_OD)*100); 








% % % % AC_OC=(tp_OC+tn_OC)/(tp_OC+fp_OC+tn_OC+fn_OC);
% % % % SE_OC=tp_OC/(tp_OC+fn_OC);
% % % % SP_OC=tn_OC/(tn_OC+fp_OC);
% % % % DI_OC=(2*tp_OC)/((2*tp_OC)+fn_OC+fp_OC);
% % % % JA_OC=tp_OC/(tp_OC+fn_OC+fp_OC);

% 
% AC_BG=(tp_BG+tn_BG)/(tp_BG+fp_BG+tn_BG+fn_BG);
% SE_BG=tp_BG/(tp_BG+fn_BG);
% SP_BG=tn_BG/(tn_BG+fp_BG);
% DI_BG=(2*tp_BG)/((2*tp_BG)+fn_BG+fp_BG);
% JA_BG=tp_BG/(tp_BG+fn_BG+fp_BG);





  im1=cat(3,imR,imG,imB);
  
  
% % % %   mask2 = bwareaopen(mask2, 250);
% % % %   [pyd, pxd]=find(mask2==1);
% % % %   
% % % %   ind_centX=find(pxd==centX);
% % % %   Ys_cent=pyd(ind_centX);
% % % %   
% % % %   
% % % %   
% % % %   pUd = min( Ys_cent);
% % % %   pLd = max(Ys_cent);
% % % %    
% % % %   pVd = abs(pUd-pLd);
% % % %   
  
  
  
%   [cx,cy]=find(GT_OD==1);
%   
%   
%   
%   
%   
%   
%   up_disc=find(cx==centX);
%   down_disc=max(cx);
  
% %   ssm = evaluateSemanticSegmentation(mask2,GT_OD,'Metrics',["bfscore","iou"]);
  
%   
%    
%      figure,imshow(im1)
% 
ImgStoreName = sprintf('%dR.tif',ff);
   imwrite(im1,ImgStoreName)
% Er=err/tot;
% % % %   fprintf(fileID,'%s\t%s\t%s\t%s\t%s\t%s\r\n',num2str(ff),num2str(AC_OD),num2str(SE_OD),num2str(SP_OD),num2str(DI_OD),num2str(JA_OD));
%%Below is SUC original
  fprintf(fileID,'%s\t%s\t%s\t%s\t%s\t%s\r\n',num2str(PREC_OD),num2str(DI_OD),num2str(JA_OD),num2str(RC_OD),num2str(FNR_OD),num2str(FPR_OD));
%Mix for ROC
% %  fprintf(fileID,'%s\t%s\t%s\t%s\t%s\t%s\r\n',num2str(SE_OD),num2str(DI_OD),num2str(JA_OD),num2str(ME_OD),num2str(SP_OD),num2str(FPR_OD));
end



